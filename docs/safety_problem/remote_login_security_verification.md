# 异地登录安全验证功能规划

## 一、功能概述

当前系统已经实现了异地登录检测功能，但还缺乏区分账号所有者与非法登录的机制。本文档规划在现有异地登录检测基础上，增加安全验证机制，允许真正的账号所有者通过二次验证在异地登录并挤掉之前的会话。

## 二、需求分析

### 1. 业务需求

- 允许真正的账号所有者在异地登录
- 提供二次安全验证机制
- 保留异地登录检测的安全保护功能
- 记录异常登录行为，便于审计

### 2. 用户场景

- **场景一**：用户在家中登录后，到办公室继续工作需要登录
- **场景二**：用户在电脑登录后，需要在手机端登录
- **场景三**：用户忘记登出，导致会话仍然保持活跃
- **场景四**：用户账号被他人盗用，需要保护账号安全

### 3. 功能需求

- 检测到异地登录时，提供二次验证选项
- 支持多种验证方式（验证码、安全问题等）
- 验证成功后，强制使旧会话失效
- 记录异地登录的详细信息
- 向原登录设备发送通知（可选）

## 三、方案设计

### 1. 技术方案概述

设计一套二次验证流程，替代当前直接拒绝异地登录的机制：

1. 用户尝试登录时，检测到已有活跃会话
2. 系统返回特殊状态码，而非错误信息
3. 前端展示异地登录提示，提供验证选项
4. 用户选择验证方式或直接确认挤掉原会话
5. 验证通过后，使旧会话失效，允许新会话创建

### 2. 验证方式

#### 方案A：验证码验证

- 向绑定的邮箱/手机发送验证码
- 用户输入验证码验证身份
- 优点：安全性高，操作简单
- 缺点：依赖外部服务，需额外开发短信/邮件服务

#### 方案B：安全问题验证

- 用户预设安全问题和答案
- 异地登录时回答问题进行验证
- 优点：不依赖外部服务，实现简单
- 缺点：安全性较低，用户可能忘记答案

#### 方案C：简单确认（低安全等级）

- 用户直接确认"这是我本人"
- 仅记录操作日志，不做二次验证
- 优点：用户体验最佳，实现最简单
- 缺点：安全性最低

### 3. 安全考虑

- 验证失败次数限制，防止暴力破解
- 记录所有验证尝试，包括IP、时间、设备信息
- 敏感操作（如修改密码）增加额外验证
- 可配置的安全策略，支持不同级别的保护

## 四、技术实现规划

### 1. 代码修改点

#### 后端修改

1. **SessionException扩展**：
   - 添加`RemoteLoginException`子类，携带当前登录信息

2. **LoginController修改**：
   - 修改登录接口，捕获`RemoteLoginException`
   - 添加强制登录接口`/api/auth/force-login`
   - 添加二次验证接口`/api/auth/verify-login`

3. **SessionManager扩展**：
   - 添加`forceLogin`方法
   - 添加登录验证记录功能

4. **数据模型扩展**：
   - 添加`LoginVerification`实体（可选）
   - 添加`SecurityQuestion`实体（如采用方案B）

#### 前端修改

1. **登录流程修改**：
   - 捕获202状态码，显示异地登录提示
   - 提供验证选项界面

2. **验证界面开发**：
   - 验证码输入界面
   - 安全问题回答界面
   - 直接确认对话框

3. **用户设置扩展**：
   - 安全问题设置界面（如采用方案B）
   - 登录通知设置

### 2. 数据库变更（如需）

1. **用户表扩展**：
   - `security_question`：安全问题
   - `security_answer`：安全问题答案（需加密存储）

2. **新增登录验证记录表**：
   - `login_verification`：记录所有验证尝试

### 3. API接口设计

```
1. 异地登录检测响应
POST /api/auth/login
Response: 
{
  "code": 202,
  "message": "检测到账号已在其他地方登录",
  "data": {
    "currentLoginIp": "192.168.1.1",
    "loginTime": "2023-04-10 10:30:12"
  }
}

2. 强制登录
POST /api/auth/force-login
Request:
{
  "sno": "学号",
  "password": "密码",
  "verificationCode": "验证码"（可选）
}

3. 发送验证码
POST /api/auth/send-verification
Request:
{
  "sno": "学号",
  "type": "email"/"phone"
}

4. 获取安全问题
GET /api/auth/security-question?sno=学号

5. 验证安全问题
POST /api/auth/verify-security-question
Request:
{
  "sno": "学号",
  "answer": "答案"
}
```

## 五、开发计划

### 1. 分支管理

- 使用分支`feature/login_safety`
- 基于现有代码进行扩展开发
- 完成后提交PR合并到主分支

### 2. 开发阶段

1. **Phase 1**: 基础框架修改
   - 后端异常类扩展
   - 登录控制器逻辑调整
   - 会话管理器功能扩展

2. **Phase 2**: 验证机制实现
   - 根据选定方案实现验证逻辑
   - 安全日志记录功能

3. **Phase 3**: 前端界面开发
   - 异地登录提示界面
   - 验证流程界面

4. **Phase 4**: 测试与优化
   - 单元测试
   - 集成测试
   - 用户体验优化

### 3. 测试要点

- 不同登录场景的验证流程
- 验证成功/失败处理
- 并发登录情况处理
- 异常场景处理（网络中断、会话过期等）
- 安全性测试（尝试绕过验证）

## 六、后续扩展考虑

- 实现多设备同时登录支持
- 登录设备管理功能
- 登录行为分析与风险评估
- 基于地理位置的登录风险评估
- 集成第三方身份验证服务

## 七、Git分支状态

当前工作在`feature/login_safety`分支上，已创建相关文档目录：
- `docs/safety_problem/`目录存放安全相关设计文档

```bash
# Git分支管理命令
git add docs/safety_problem/
git commit -m "docs: 添加异地登录安全验证功能规划文档"
git push -u origin feature/login_safety
```

## 八、注意事项与风险

1. **向后兼容性**：
   - 确保现有登录流程不受影响
   - 客户端版本兼容处理

2. **性能考虑**：
   - 验证过程不应显著增加响应时间
   - 考虑验证请求的限流机制

3. **安全风险**：
   - 避免二次验证机制成为新的安全漏洞
   - 防范会话固定攻击

4. **用户体验**：
   - 验证流程应尽可能简洁明了
   - 提供清晰的错误提示和帮助信息 